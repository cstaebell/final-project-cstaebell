---
title: "Starry Night?"
subtitle: An exploration of nighttime lights and the Dark-Sky Movement in the US
author: Carly Staebell
date: today
date-format: long
code-fold: true
code-tools:
  toggle: true
execute:
  message: false
  warning: true
  echo: true
  output: true
---

# Introduction

Electric lights have benefited society immensely since their invention in 1879. Modern work, recreation, and transportation are made possible largely due to artificial lighting. However, when artificial outdoor lighting becomes inefficient and unnecessary, it is known as light pollution, with negative impacts on both wildlife and humans [1]. 

Concerns about the effects of light pollution on astronomy led to the 1988 formation of the nonprofit now known as DarkSky International [2]. Since then, DarkSky has grown into a recognized global authority on light pollution with a mission to safeguard communities and wildlife against light pollution [3]. The organization's International Dark Sky Places program allows communities, parks, and protected areas to seek certification for efforts to preserve and protect their dark skies [4]. 

Notably, Flagstaff, Arizona was the first International Dark Sky Place, designated in 2001. As a hub for astronomical observation, the city has been a leader in outdoor lighting policy since 1958 [5]. Other cities, particularly those in the western US, have also recognized the need for measures to combat light pollution, and have achieved DarkSky certification. While certification is certainly not necessary for communities to implement outdoor lighting ordinances and other measures to curb light pollution, it is an indicator of places that have made dark sky conservation a priority. 

This project aims to explore trends in nighttime light levels first from a national contiguous US perspective, and through more detailed case studies of individual cities. 

# Materials and methods

Three Dark Sky Certified communities with different sizes and designation dates have been selected: 

* Flagstaff, Arizona: Population ~77,000, designated 2001;
* Homer Glen, Illinois: Population ~25,000, designated 2011;
* Bee Cave, Texas: Population ~9,000, designated 2023.

These three communities will each be paired with a community of similar size that has fewer, if any, ordinances controlling light pollution. Each community pair will be examined to see if there are observable differences in nighttime light emissions.

Data are sourced from NASA's Black Marble annual nighttime lights product, MODIS yearly land use/land cover, and the US Census.


```{r load packages}
#| warning: false
#| output: false

library(tidyverse)
library(leaflet)
library(kableExtra)
library(htmlwidgets)
library(widgetframe)
knitr::opts_chunk$set(widgetframe_widgets_dir = 'widgets' ) 
knitr::opts_chunk$set(cache=TRUE)  # cache the results for quick compiling

library(blackmarbler)
library(sf)
library(terra)
library(tigris)
library(tidyterra)
library(tidycensus)
library(patchwork)
library(piggyback)
```


## Download and clean all required data

### National Nighttime Lights

NASA black marble annual data for 2014 through 2024 were downloaded and saved in a separate script ('black_marble_data_download.R'). The 2024 nighttime lights across the contiguous US are visualized below. 
```{r Download 2024 national raster}
#| warning: false
#| output: false

# Define national spatial extent
nonconus <- c("Guam", "Hawaii", "Alaska",
              "Commonwealth of the Northern Mariana Islands",
              "United States Virgin Islands", "American Samoa", "Puerto Rico")

states_sf <- states() |>
  filter(!NAME %in% nonconus) |>
  select(NAME, geometry) |>
  st_transform(crs = "epsg:4326")

conus <- st_union(states_sf)|>
  st_as_sf()

# Read in national data for 2024 (to be used for leaflet map later)
pb_download("US_VNP46A4_NearNadir_Composite_Snow_Free_qflag_t2024.tif", 
            repo = "cstaebell/final-project-cstaebell")

us_2024_rast <- rast("US_VNP46A4_NearNadir_Composite_Snow_Free_qflag_t2024.tif") |>
  mask(conus)
```

```{r Plot national raster}
#| warning: false

log_us_2024 <- app(us_2024_rast, fun = log1p)

ggplot() +
  geom_spatraster(data = log_us_2024) + 
  scale_fill_gradient2(low = "black",
                       mid = "yellow", 
                       high = "red",
                       midpoint = 4.5,
                       na.value = "transparent") +
  labs(title = "Nighttime Lights: 2024") +
  coord_sf() +
  theme_void() +
  theme(legend.position = "none")
```

Mean nighttime light radiance for the entire contiguous US is plotted below, where a generally increasing trend can be observed over the past ten years.
 
```{r Download and process CONUS data from GitHub Releases}
#| warning: false
  
years = 2014:2024
conus_means = numeric(length(years))

for (i in 1:length(years)) {
  pb_download(paste("CONUS_VNP46A4_NearNadir_Composite_Snow_Free_qflag_mean_t",
                             years[i], ".Rds", sep = ""), repo = "cstaebell/final-project-cstaebell")
  annual_mean <- readRDS(paste("CONUS_VNP46A4_NearNadir_Composite_Snow_Free_qflag_mean_t",
                             years[i], ".Rds", sep = "")) |>
    pull(ntl_mean)
  
  conus_means[i] <- annual_mean
}

conus_df <- data.frame(year = years, mean_ntl = conus_means)

ggplot(conus_df) +
  geom_point(aes(x = year, y = mean_ntl)) +
  geom_smooth(aes(x = year, y = mean_ntl)) +
  labs(x = "Year", y = expression("Mean Radiance (nW cm"^-2~"sr"^-1*")"),
       title = "Annual US Mean Radiance (2014 - 2024)") +
  theme_light()
```
Getting more granular, we can look at state means.

```{r Process annual state NTL data}
#| warning: false
#| output: false

state_means <- matrix(nrow = 49, ncol = length(years))
state_pixels <- matrix(nrow = 49, ncol = length(years))

# Read in annual data for states and create a single data frame
for (i in 1:length(years)) {
  pb_download(paste("US_VNP46A4_NearNadir_Composite_Snow_Free_qflag_mean_t",
                             years[i], ".Rds", sep = ""), repo = "cstaebell/final-project-cstaebell")
  annual_mean <- readRDS(paste("US_VNP46A4_NearNadir_Composite_Snow_Free_qflag_mean_t",
                             years[i], ".Rds", sep = ""))
  
  state_means[,i] <- annual_mean[,2]
  state_pixels[,i] <- annual_mean[,3]
  
  # check that state names are ordered the same way for each year
  if (i == 1) {
    state_names <- annual_mean[,1]
  } else {
    if (sum(state_names != annual_mean[,1]) != 0) {
      print("Different state names")
    }
  }
}

state_means_df <- data.frame(state_means)
colnames(state_means_df) <- paste("ntl_", years, sep = "")
state_means_df <- state_means_df |>
  mutate(state = state_names, 
         pct_change = (ntl_2024 - ntl_2014) / ntl_2014 * 100)


# Combine NTL data with geographic data
states_ntl <- state_means_df |>
  inner_join(states_sf, by = c("state" = "NAME"))

states_ntl <- states_sf |>
  inner_join(state_means_df, by = c("NAME" = "state"))
```


```{r national choropleths}
# Create choropleths
st_2024_mean_map <- ggplot() +
  geom_sf(data = filter(states_ntl, NAME != "District of Columbia"), aes(fill = ntl_2024)) +
  labs(title = "Mean Annual Nighttime Lights by State, 2024")

st_pct_change_map <- ggplot() + 
  geom_sf(data = states_ntl, aes(fill = pct_change))

st_2024_mean_map / st_pct_change_map
```


### Case Studies 

For case study analyses, population data and local geographies were downloaded from the US Census.

```{r Download census data}
#| output: false

# Download population data
us_pop <- get_acs(geography = "place", state = NULL, 
                  variables = "B01003_001", key = census_api_key)

az_pop <- get_acs(geography = "place", state = "AZ", 
                         variables = "B01003_001", key = census_api_key)

il_pop <- get_acs(geography = "place", state = "IL", 
                         variables = "B01003_001", key = census_api_key)

tx_pop <- get_acs(geography = "place", state = "TX", 
                         variables = "B01003_001", key = census_api_key)

# Download local geographies: selected Dark Sky Places
flagstaff <- places(state = "AZ", cb = TRUE, year = 2024) |>
  filter(NAME == "Flagstaff") |>
  st_transform(crs = "epsg:4326") |>
  left_join(us_pop, by = "GEOID")

homerglen <- places(state = "IL", cb = TRUE, year = 2024) |>
  filter(NAME == "Homer Glen") |>
  st_transform(crs = "epsg:4326") |>
  left_join(us_pop, by = "GEOID")

beecave <- places(state = "TX", cb = TRUE, year = 2024) |>
  filter(NAME == "Bee Cave") |>
  st_transform(crs = "epsg:4326") |>
  left_join(us_pop, by = "GEOID")

```

Cities of similar population size were found for each selected Dark-Sky community. The city selection process focused on states that do not have laws regarding light pollution or dark sky protection, as compiled by Schultz [6].

```{r Process census data}
#| output: false

# Find suitable comparison cities
flagstaff_sim_pop <- us_pop |> filter(estimate >= (flagstaff$estimate - 0.01*flagstaff$estimate) 
                                & estimate <= (flagstaff$estimate + 0.01*flagstaff$estimate)) |>
  separate(NAME, into = c("city", "state"), sep = ", ")

homerglen_sim_pop <- us_pop |> filter(estimate >= (homerglen$estimate - 0.005*homerglen$estimate) 
                                & estimate <= (homerglen$estimate + 0.005*homerglen$estimate)) |>
  separate(NAME, into = c("city", "state"), sep = ", ")

beecave_sim_pop <- us_pop |> filter(estimate >= (beecave$estimate - 0.005*beecave$estimate) 
                                & estimate <= (beecave$estimate + 0.005*beecave$estimate)) |>
  separate(NAME, into = c("city", "state"), sep = ", ")

# Download/process comparison city data
 # Flagstaff counterpart
scranton <- places(state = "PA", cb = TRUE, year = 2024) |>
  filter(NAME == "Scranton") |>
  left_join(us_pop, by = "GEOID") |>
  st_transform(crs = "epsg:4326")

 # Homer Glen counterpart
belvidere <- places(state = "IL", cb = TRUE, year = 2024) |>
  filter(NAME == "Belvidere") |>
  left_join(us_pop, by = "GEOID") |>
  st_transform(crs = "epsg:4326")

 # Bee Cave counterpart
clanton <- places(state = "AL", cb = TRUE, year = 2024) |>
  filter(NAME == "Clanton") |>
  left_join(us_pop, by = "GEOID") |>
  st_transform(crs = "epsg:4326")

```


```{r Read in yearly national raster data}
# Subset rasters to each area 
cities <- list(flagstaff, homerglen, beecave, scranton, belvidere, clanton)
city_rasters <- vector("list", length = length(cities))

# Load files for each year
for (i in 1:length(years)){
  pb_download(paste("US_VNP46A4_NearNadir_Composite_Snow_Free_qflag_t", 
                     years[i], ".tif", sep = ""), repo = "cstaebell/final-project-cstaebell")
  rast_file <- paste("US_VNP46A4_NearNadir_Composite_Snow_Free_qflag_t", 
                     years[i], ".tif", sep = "")
  
  year_rast <- rast(rast_file)
  
  # Loop over cities
  for (j in 1:length(cities)) {
    # Crop and mask to city extent
    current_rast <- year_rast |>
      terra::crop(cities[[j]]) |>
      mask(cities[[j]])
    
    # Create list entry during first iteration, then append in subsequent iterations
    if (i == 1) {
    city_rasters[[j]] <- list(current_rast)
    } else {
    city_rasters[[j]][[length(city_rasters[[j]]) + 1]] <- current_rast
    }
  }
}

# Stack city lists 
city_rasters <- lapply(city_rasters, rast)

# Create separate rasters for each city
city_var_names <- paste0(c("flagstaff", "homerglen", "beecave", "scranton", 
                           "belvidere", "clanton"), "_rast")
for (c in 1:length(city_var_names)) {
  assign(city_var_names[c], city_rasters[[c]])
}

# Calculate annual means
annual_means <- vector("list", length = length(cities))
for (i in 1:length(city_rasters)) {
  ntl_vals <- data.frame(values(city_rasters[[i]])) |>
    summarize(across(t2014:t2024, ~ mean(.x, na.rm = TRUE)))
  
  annual_means[[i]] <- ntl_vals
}

# Create mean dataframes for each city
city_df_var_names <- paste0(c("flagstaff", "homerglen", "beecave", "scranton", 
                           "belvidere", "clanton"), "_means")
for (i in 1:length(annual_means)) {
  df <- annual_means[[i]] |>
    pivot_longer(cols = t2014:t2024) |>
    mutate(name = years) |>
    rename(year = name, mean_ntl = value)
  
  assign(city_df_var_names[i], df)
}

```


Simply looking at annual means for each city is more of a proxy for overall development than it is for lighting policy. Therefore, we need to look at land use and only compare the urban and built-up areas. 

```{r compare cities}
# Annual means
fs_means <- ggplot() +
  geom_line(data = flagstaff_means, aes(x = year, y = mean_ntl), color = "blue") +
  geom_line(data = scranton_means, aes(x = year, y = mean_ntl), color = "red") +
  labs(x = "Year", y = "Mean NTL", title = "Flagstaff and Scranton Annual Mean Nighttime Lights")

hb_means <- ggplot() +
  geom_line(data = homerglen_means, aes(x = year, y = mean_ntl), color = "blue") +
  geom_line(data = belvidere_means, aes(x = year, y = mean_ntl), color = "red") +
  labs(x = "Year", y = "Mean NTL", title = "Homer Glen and Belvidere Annual Mean Nighttime Lights")

bc_means <- ggplot() +
  geom_line(data = beecave_means, aes(x = year, y = mean_ntl), color = "blue") +
  geom_line(data = clanton_means, aes(x = year, y = mean_ntl), color = "red") +
  labs(x = "Year", y = "Mean NTL", title = "Bee Cave and Clanton Annual Mean Nighttime Lights")

fs_means + hb_means + bc_means

```

```{r download and process local nighttime lights data, eval = F}










# calculate mean normalized radiance
flagstaff_area_km <- flagstaff$ALAND / 1000^2
scranton_area_km <- scranton$ALAND / 1000^2

scranton_rad <- data.frame(values(scranton_bm_rast)) |>
  summarize(across(t2012:t2024, mean, na.rm = TRUE)) |>
  pivot_longer(cols = t2012:t2024, names_to = "year", values_to = "sc_mean") |>
  mutate(year = as.integer(sub("t", "", year)),
         sc_a_norm_mean = sc_mean / scranton_area_km)
```


MODIS data was downloaded via AppEEARS. The proportion of land classified as urban and built-up was calculated and applied as a coefficient to the land area, which was then used to normalize the mean radiance. At this point, the analysis was only done for Flagstaff, AZ, and its paired city of Scranton, PA.


```{r land use data}

# define land cover descriptions
Land_Cover_Type_1 <- c(
  "Water" = 0, "Evergreen Needleleaf forest" = 1, "Evergreen Broadleaf forest" = 2,
  "Deciduous Needleleaf forest" = 3, "Deciduous Broadleaf forest" = 4, "Mixed forest" = 5,
  "Closed shrublands" = 6, "Open shrublands" = 7, "Woody savannas" = 8, "Savannas" = 9,
  "Grasslands" = 10, "Permanent wetlands" = 11, "Croplands" = 12, "Urban & built-up" = 13,
  "Cropland/Natural vegetation mosaic" = 14, "Snow & ice" = 15, "Barren/Sparsely vegetated" = 16
)

lcd <- data.frame(
  ID = Land_Cover_Type_1,
  landcover = names(Land_Cover_Type_1),
  stringsAsFactors = FALSE
)

# calculate urban/built-up area 

fs_lulc <- rast("data/MCD12Q1.061_LC_Type1_doy2024001000000_aid0001-fs.tif") |>
  crop(flagstaff) |>
  mask(flagstaff)

levels(fs_lulc) <- lcd
plot(fs_lulc, main = "Land Use in Flagstaff, AZ")

fs_type_summary <- data.frame(values(fs_lulc)) |>
  drop_na() |>
  group_by(landcover) |>
  summarize(tot_pixels = n())

fs_prop_urban <- fs_type_summary |>
  filter(landcover == "Urban & built-up") |>
  summarise(prop_urban = tot_pixels / sum(fs_type_summary$tot_pixels)) |>
  pull(prop_urban)

sc_lulc <- rast("data/MCD12Q1.061_LC_Type1_doy2024001000000_aid0001-sc.tif") |>
  crop(scranton) |>
  mask(scranton)
levels(sc_lulc) <- lcd
plot(sc_lulc, main = "Land Use in Scranton, PA")

sc_type_summary <- data.frame(values(sc_lulc)) |>
  drop_na() |>
  group_by(landcover) |>
  summarize(tot_pixels = n())

sc_prop_urban <- sc_type_summary |>
  filter(landcover == "Urban & built-up") |>
  summarise(prop_urban = tot_pixels / sum(sc_type_summary$tot_pixels)) |>
  pull(prop_urban)


```

The following chunk works locally but will not render; I'm still figuring this out.

```{r land use process2, eval = F}

# calculate mean normalized radiance
flagstaff_urban_km <- (flagstaff$ALAND * fs_prop_urban / 1000^2)[1,1]
scranton_urban_km <- (scranton$ALAND * sc_prop_urban / 1000^2)[1,1]

scranton_rad <- data.frame(values(scranton_bm_rast)) |>
  summarize(across(t2012:t2024, mean, na.rm = TRUE)) |>
  pivot_longer(cols = t2012:t2024, names_to = "year", values_to = "rad_mean") |>
  mutate(year = as.integer(sub("t", "", year)),
         a_norm_mean = rad_mean / scranton_urban_km, 
         city = "Scranton")

flagstaff_rad <- data.frame(values(flagstaff_bm_rast)) |>
  summarize(across(t2012:t2024, mean, na.rm = TRUE)) |>
  pivot_longer(cols = t2012:t2024, names_to = "year", values_to = "rad_mean") |>
  mutate(year = as.integer(sub("t", "", year)),
         a_norm_mean = rad_mean / flagstaff_urban_km,
         city = "Flagstaff")

flagstaff_comp_df <- flagstaff_rad |>
  bind_rows(scranton_rad)

ggplot(flagstaff_comp_df) +
  geom_line(aes(x = year, y = a_norm_mean)) +
  facet_wrap(~ city) +
  labs(x = "Year", y = "Urban Area Normalized Mean Radiance",
       title = "Annual Mean Radiance Normalized by Urban Area")

```

# Open questions/further exploration: 

* Look into land use for each year of nighttime lights data, but for now I'm operating under the assumption that land use has not changed significantly between 2012 and 2024.

* Reconsider order of analysis. Instead of taking mean of entire study area and then applying urban area correction, restrict area of interest for nighttime lights data to urban areas, get mean and then normalize by area?

* See if conclusions can be drawn after all cities are processed. This includes looking at the lighting policies in each city. 

* Some cities are switching from orange high pressure sodium lamps to white LEDs. VIIRS spectral range does not completely cover the blue light peak of many modern white LEDs, which can lead to somewhat misleading decreases in satellite-observed radiance.

# Results



# Conclusions



# References

Bocinsky, R.K., Beaudette, D., Chamberlain, S., Hollister, J., Gustavsen, J. (2025). Package 'FedData'. <https://cran.r-project.org/web/packages/FedData/FedData.pdf>.

Chepesiuk, R. (2009). Missing the dark: health effects of light pollution. Environmental Health Perspectives, 117(1), A20+. <https://www.jstor.org/stable/40066663>.

DarkSky International. (2015). Flagstaff, Arizona. <https://darksky.org/places/flagstaff-arizona-dark-sky-community/>.

DarkSky International. (2025a). About DarkSky. <https://darksky.org/about/#mission>.

DarkSky International (2025b). International Dark Sky Places. <https://darksky.org/what-we-do/international-dark-sky-places/>.

Hunter, T., (2023). The birth of DarkSky (IDA) and a lifelong mission fighting light pollution. DarkSky. <https://darksky.org/news/the-birth-of-ida-and-a-lifelong-mission-fighting-light-pollution/>.

Marty, R., Vicente, G.S. (2025). Package 'blackmarbler'. <https://cran.r-project.org/web/packages/blackmarbler/blackmarbler.pdf>.

NASA. Black Marble. <https://blackmarble.gsfc.nasa.gov/>.

Román, M. O., Wang, Z., Sun, Q., Kalb, V., Miller, S. D., Molthan, A., Schultz, L., Bell, J., Stokes, E. C., Pandey, B., Seto, K. C., Hall, D., Oda, T., Wolfe, R. E., Lin, G., Golpayegani, N., Devadiga, S., Davidson, C., Sarkar, S., Praderas, C., Schmaltz, J., Boller, R., Stevens, J., Ramos González, O. M., Padilla, E., Alonso, J., Detrés, Y., Armstrong, R., Miranda, I., Conte, Y., Marrero, N., MacManus, K., Esch, T., Masuoka, E. J. (2018). NASA's Black Marble nighttime lights product suite. Remote Sensing of Environment, 210: 113-143, <https://doi.org/10.1016/j.rse.2018.03.017>.

Schultz, J. (2022). States shut out light pollution. National Conference of State Legislatures. <https://www.ncsl.org/environment-and-natural-resources/states-shut-out-light-pollution>

Stare, J., Kyba, C. (2025): Radiance Light Trends. GFZ Data Services. <https://doi.org/10.5880/GFZ.1.4.2019.001>.

Walker, K., Herman, M. (2025). tidycensus: Load US Census Boundary and Attribute Data as 'tidyverse' and 'sf'-Ready Data Frames. R package version 1.7.3, <https://walker-data.com/tidycensus/>.

Weishampel, Z.A., Cheng, W.-H. and Weishampel, J.F. (2016), Sea turtle nesting patterns in Florida vis-à-vis satellite-derived measures of artificial lighting. Remote Sens Ecol Conserv, 2: 59-72. <https://doi.org/10.1002/rse2.12>.
